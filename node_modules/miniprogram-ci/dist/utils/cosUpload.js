"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.uploadToCosInCI=exports.uploadToCosCore=void 0;const env_1=require("./env"),COS=require("cos-js-sdk-v5"),COSForNode=require("cos-nodejs-sdk-v5"),fs=require("fs");function compareCache(e,o){const t=Object.keys(o);for(const r of Object.keys(e)){if(!t.includes(r))return!1;if(o[r]!=e[r])return!1}return!0}async function uploadToCosCore({uploadBuf:e,region:o,getUploadInfoFunc:t,getAuthFunc:r,onProgress:n}){return new Promise((i,s)=>{t().then(t=>{let u=null;const l="undefined"==typeof Blob||"undefined"==typeof XMLHttpRequest||env_1.isDevtools,a=new(l?COSForNode:COS)({getAuthorization(e,o){var n;if(1!=e.Scope.length)return void o("");const i=Object.assign({},t,{action:e.Scope[0].action});(null===(n=e.Query)||void 0===n?void 0:n.uploadId)&&(i.uploadId=e.Query.uploadId),null!==u&&compareCache(i,u)&&u.AuthExpireTime>Math.round(Date.now()/1e3)?o({Authorization:u.Authorization,SecurityToken:u.SecurityToken,SignFrom:"client"}):r(i).then(e=>{u=Object.assign({},i,{Authorization:e.Authorization,SecurityToken:e.SecurityToken,SignFrom:"client",AuthExpireTime:e.AuthExpireTime}),o({Authorization:e.Authorization,SecurityToken:e.SecurityToken,SignFrom:"client"})},()=>{o("")})}});let c=void 0,d={};if(l)if("string"==typeof e){if(!fs.existsSync(e)||fs.statSync(e).isDirectory())throw new Error(`[upload Cos failed] file path$ ${e} is not a file or not exists`);d.name=e}else try{const o=require("tmp");o.setGracefulCleanup(),d=o.fileSync({mode:420,prefix:"",postfix:""}),fs.writeSync(d.fd,e,0,e.length,null),fs.closeSync(d.fd)}catch(e){throw console.error("Error:",e),new Error("[upload Cos failed] write compileresult to tmp file failed: "+e.message)}else{if("string"==typeof e)throw new Error("[upload Cos failed] uploadBuf must be typeof Buffer when is not in node");c=new Blob([e],{type:"application/octet-stream"})}a.sliceUploadFile({Bucket:t.bucket,Region:o,Key:t.object,Body:c,FilePath:d.name,SliceSize:5242880,onProgress(e){null==n||n(e)},AsyncLimit:1},(e,o)=>{e?s({err:e,data:o}):i({err:e,data:o})})},e=>{s({err:e})})})}function uploadToCosInCI(){}exports.uploadToCosCore=uploadToCosCore,exports.uploadToCosInCI=uploadToCosInCI;