"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.compareSemVer=exports.isMiniProgramCodeFile=exports.isCodeFile=exports.getSupportCodeFileExtSet=exports.getCompilerPlugins=exports.sourcePathToTargetPath=exports.checkIsUseCompilerPlugins=exports.isMiniappPlatform=exports.isPluginType=exports.isGameApp=exports.isLeftSubPathOfRight=exports.pathRelative=exports.compareVersion=exports.unifyPath=exports.getWorkersPath=exports.getPluginJson=exports.getAppJson=exports.getTerm=exports.checkIsIndependentSubpackage=exports.checkIsInSubPackage=exports.devtoolsError=exports.devtoolsLog=exports.devtoolsInfo=exports.formatTime=exports.formatNumber=exports.generateMD5=exports.generateFileMD5=exports.formatSourceMap=exports.isFileIncluded=exports.isFileIgnored=exports.leading=exports.trailing=exports.escapeQuot=exports.mkdirSync=exports.rmSync=exports.isHexColor=exports.formatJSONParseErr=exports.bufferToUtf8String=exports.getType=exports.wrapCodeByEval=exports.escapeScript=exports.joinPath=exports.normalizePath=void 0;const tslib_1=require("tslib"),fs_1=tslib_1.__importDefault(require("fs")),path_1=tslib_1.__importDefault(require("path")),crypto_1=tslib_1.__importDefault(require("crypto")),babel_code_frame_1=tslib_1.__importDefault(require("babel-code-frame")),minimatch_1=tslib_1.__importDefault(require("minimatch")),startWith_1=tslib_1.__importDefault(require("licia/startWith")),fs_extra_1=tslib_1.__importDefault(require("fs-extra")),lodash_1=tslib_1.__importDefault(require("lodash")),define_1=require("../config/define"),env_1=require("./env"),types_1=require("../types"),jsonlint=require("./jsonlint");function normalizePath(e=""){const t=path_1.default.posix.normalize(e.replace(/\\/g,"/"));return!e.startsWith("//")&&!e.startsWith("\\\\")||t.startsWith("//")?t:"/"+t}function joinPath(e="",t=""){const r=path_1.default.posix.join(e,t);return!e.startsWith("//")&&!e.startsWith("\\\\")||r.startsWith("//")?r:"/"+r}function escapeScript(e){return e?e.replace(/<script/g,"&lt;script").replace(/<\/script/g,"&lt;/script"):e}function wrapCodeByEval(e){return`;(window.eval || __global.__hackEval)('${e}')`}function getType(e){return Object.prototype.toString.call(e).toLowerCase().split(" ")[1].replace("]","")}exports.normalizePath=normalizePath,exports.joinPath=joinPath,exports.escapeScript=escapeScript,exports.wrapCodeByEval=wrapCodeByEval,exports.getType=getType;const bufferToUtf8String=e=>{const t=e.toString();if(0===Buffer.compare(Buffer.from(t,"utf8"),e))return t};function getErrLine(e,t,r,s){r=r>0?r:1;return`${s}\n${(0,babel_code_frame_1.default)(e,t,r)}`}exports.bufferToUtf8String=bufferToUtf8String;const formatJSONParseErr=e=>{const t=e.data||"";try{jsonlint.parser.parse(t)}catch(r){try{const s=`Expecting ${r.expected}, got ${r.token}`,o=getErrLine(t,r.line,r.loc.first_column,s);return`${e.filePath}\n${o}`}catch(e){}}return`${e.filePath}\n${e.error}`};exports.formatJSONParseErr=formatJSONParseErr;const isHexColor=e=>/^#[a-f\d]{3}$/i.test(e)||/^#[a-f\d]{4}$/i.test(e)||/^#[a-f\d]{6}$/i.test(e)||/^#[a-f\d]{8}$/i.test(e);function rmSync(e){try{if(e=path_1.default.resolve(e),!fs_1.default.existsSync(e))return;if(fs_1.default.lstatSync(e).isDirectory()){const t=fs_1.default.readdirSync(e);if(t.length>0)for(let r=0,s=t.length;r<s;r++)rmSync(path_1.default.posix.join(e,t[r]));fs_1.default.rmdirSync(e)}else fs_1.default.unlinkSync(e)}catch(e){}}function mkdirSync(e){if(e=path_1.default.resolve(e),fs_1.default.existsSync(e)){if(fs_1.default.lstatSync(e).isDirectory())return;fs_1.default.unlinkSync(e)}mkdirSync(path_1.default.dirname(e)),fs_1.default.mkdirSync(e)}function escapeQuot(e,t="`"){return e?"`"===t?e.replace(/\\/g,"\\\\").replace(/`/g,"\\`").replace(/\$/g,"\\$"):'"'===t?e.replace(/\\/g,"\\\\").replace(/\r\n/g,"\n").replace(/\n/g,"\\n").replace(/"/g,'\\"'):"'"===t?e.replace(/\\/g,"\\\\").replace(/\r\n/g,"\n").replace(/\n/g,"\\n").replace(/'/g,"\\'"):e:e}function trailing(e,t,r=!1){return r?e.endsWith(t)?e.slice(0,e.length-1):e:e.endsWith(t)?e:e+t}function leading(e,t,r=!1){return r?e.startsWith(t)?e.slice(1):e:e.startsWith(t)?e:t+e}exports.isHexColor=isHexColor,exports.rmSync=rmSync,exports.mkdirSync=mkdirSync,exports.escapeQuot=escapeQuot,exports.trailing=trailing,exports.leading=leading;const FFSPRGRulesFactory=function(e){let t=null,r=Object.create(null);return function(e,s){if(s.length<1)return!1;if(t===s){if(void 0!==r[e])return r[e]}else t=s,r=Object.create(null);const o=e.replace(/\\/g,"/").toLowerCase();if(!o)return!1;const n=o.slice(o.lastIndexOf("/")+1);let i=!1;for(const e of s){if(!e)continue;const t=e.value.toLowerCase();if("prefix"===e.type)i=n.startsWith(t);else if("suffix"===e.type)i=n.endsWith(t);else if("folder"===e.type)i=leading(o,"/").startsWith(trailing(leading(t,"/"),"/"));else if("file"===e.type)i=leading(o,"/")===leading(t,"/");else if("glob"===e.type)try{i=(0,minimatch_1.default)(o,t)||(0,minimatch_1.default)(leading(o,"/"),t)}catch(e){i=!1}else if("regexp"===e.type)try{i=new RegExp(t,"igm").test(o)||new RegExp(t,"igm").test(leading(o,"/"))}catch(e){i=!1}if(i)break}return r[e]=i,i}};function formatSourceMap(e){if(e){if("string"===getType(e))return e;try{return JSON.stringify(e)}catch(e){}}}async function generateFileMD5(e){return new Promise((t,r)=>{const s=crypto_1.default.createHash("md5"),o=fs_1.default.createReadStream(e);o.on("data",e=>{s.update(e)}),o.on("end",()=>{const e=s.digest("hex");t(e)}),o.on("error",e=>{r(e)})})}function generateMD5(e){const t=crypto_1.default.createHash("md5");return t.update(e),t.digest("hex")}exports.isFileIgnored=FFSPRGRulesFactory(),exports.isFileIncluded=FFSPRGRulesFactory(),exports.formatSourceMap=formatSourceMap,exports.generateFileMD5=generateFileMD5,exports.generateMD5=generateMD5;const formatNumber=e=>e>9?""+e:"0"+e;exports.formatNumber=formatNumber;const formatTime=e=>{const t=e.getFullYear(),r=e.getMonth()+1,s=e.getDate(),o=e.getHours(),n=e.getMinutes(),i=e.getSeconds();return`${[t,r,s].map(exports.formatNumber).join("/")} ${[o,n,i].map(exports.formatNumber).join(":")}`};function devtoolsInfo(...e){env_1.isDevtools&&console.info(...e)}function devtoolsLog(...e){env_1.isDevtools&&console.log(...e)}function devtoolsError(...e){env_1.isDevtools&&console.error(...e)}function getPluginByAliasOrProvider(e,t){if(e){const r=e[t];if(r)return{alias:t,provider:r.provider,version:r.version};for(const r in e){const s=e[r];if(s.provider===t)return{alias:r,provider:s.provider,version:s.version}}}}function checkPluginByAliasOrProvider(e,t){let r;if(e.subPackages)for(const s of e.subPackages)if(r=getPluginByAliasOrProvider(s.plugins,t),r)return Object.assign(Object.assign({},r),{config:s});if(r=getPluginByAliasOrProvider(e.plugins,t),r)return r}function checkIsInSubPackage(e,t=""){let r;if((0,startWith_1.default)(t,"plugin://")){const r=t.match(/^plugin:\/\/([^/]*)\/(.*)/),s=null==r?void 0:r[1];if(!s)return;const o=checkPluginByAliasOrProvider(e,s);return null==o?void 0:o.config}if(e.subPackages)for(let s=0,o=e.subPackages.length;s<o;s++){const o=e.subPackages[s];if(t.startsWith(o.root)){r=o;break}}return r}function checkIsIndependentSubpackage(e,t){const r=checkIsInSubPackage(e,t);if(r&&!0===r.independent)return r}function getTerm(){if(!!!(null===window||void 0===window?void 0:window.nw))return require("terminal-kit").terminal}function getTargetPlatformJson(e,t=define_1.PLATFORM["mini-weixin"]){const r=Object.values(define_1.PLATFORM),s=fs_extra_1.default.readJsonSync(e),o=lodash_1.default.omit(s,r);return lodash_1.default.merge(o,s[t]||("mini-weixin"===t?s["mini-wechat"]:{}))}function getAppJson(e,t=define_1.PLATFORM["mini-weixin"]){const r=path_1.default.join(e.projectPath,e.miniprogramRoot||"","app.json");if(!fs_extra_1.default.existsSync(r))throw Error("no found app.json");return getTargetPlatformJson(r,t)}function getPluginJson(e,t=define_1.PLATFORM["mini-weixin"]){const r=path_1.default.join(e.projectPath,e.pluginRoot||"","plugin.json");if(!fs_extra_1.default.existsSync(r))throw Error("no found plugin.json");return getTargetPlatformJson(r,t)}exports.formatTime=formatTime,exports.devtoolsInfo=devtoolsInfo,exports.devtoolsLog=devtoolsLog,exports.devtoolsError=devtoolsError,exports.checkIsInSubPackage=checkIsInSubPackage,exports.checkIsIndependentSubpackage=checkIsIndependentSubpackage,exports.getTerm=getTerm,exports.getAppJson=getAppJson,exports.getPluginJson=getPluginJson;const getWorkersPath=e=>"string"==typeof e?e:e.path;exports.getWorkersPath=getWorkersPath;const unifyPath=e=>e.replace(/\\/g,"/");exports.unifyPath=unifyPath;const compareVersion=(e,t)=>{const r=/^(\d+\.\d+\.\d+)(-.*)?$/,s=e=>{const t=e.match(r);return t?t[1]:""};let o=s(e),n=s(t);if(""===o||""===n)return-2;o=o.split("."),n=n.split(".");const i=Math.max(o.length,n.length);for(;o.length<i;)o.push("0");for(;n.length<i;)n.push("0");for(let e=0;e<i;e++){const t=parseInt(o[e],10),r=parseInt(n[e],10);if(t>r)return 1;if(t<r)return-1}return 0};exports.compareVersion=compareVersion;const pathRelative=(e,t)=>(e=path_1.default.posix.normalize(e.replace(/\\/g,"/")),t=path_1.default.posix.normalize(t.replace(/\\/g,"/")),path_1.default.posix.relative(e,t));function _isLeftSubPathOfRight(e,t){if(!t)return!0;if(t=normalizePath(t),e=normalizePath(e),!t.endsWith("/")){if(e===t)return!0;t+="/"}return!!e.startsWith(t)}function isLeftSubPathOfRight(e,t){void 0===e&&(console.error(new Error("The child string is undefined here, please check!!")),e="");const r=e.startsWith(t),s=_isLeftSubPathOfRight(e,t);return r!==s&&console.error(new Error(`${e} ${t} difference check sub path here! new result: ${s}`)),s}function isGameApp(e){return e.type===types_1.EProjectType.miniGame||e.type===types_1.EProjectType.miniGamePlugin}function isPluginType(e){return e.type===types_1.EProjectType.miniGamePlugin||e.type===types_1.EProjectType.miniProgramPlugin}function isMiniappPlatform(e){return!!e&&("mini-android"===e||"mini-ios"===e)}exports.pathRelative=pathRelative,exports.isLeftSubPathOfRight=isLeftSubPathOfRight,exports.isGameApp=isGameApp,exports.isPluginType=isPluginType,exports.isMiniappPlatform=isMiniappPlatform;const checkIsUseCompilerPlugins=()=>!0;exports.checkIsUseCompilerPlugins=checkIsUseCompilerPlugins;const sourceExt2TargetExtConf={".ts":".js",".less":".wxss",".sass":".wxss",".scss":".wxss"},sourcePathToTargetPath=e=>{const t=path_1.default.extname(e);return sourceExt2TargetExtConf[t]?e.substr(0,e.length-t.length)+sourceExt2TargetExtConf[t]:e};function getCompilerPlugins(e){const t=new Set;function r(e){"typescript"!==e&&"less"!==e&&"sass"!==e||t.add(e)}return e.setting.useCompilerPlugins&&e.setting.useCompilerPlugins.forEach(e=>{"string"==typeof e?r(e):Array.isArray(e)&&"string"==typeof e[0]&&void 0!==e[1]&&r(e[0])}),Array.from(t.values())}function getSupportCodeFileExtSet(e){const t=getCompilerPlugins(e),r=new Set([".js",".json",".wxss",".wxs",".wxml"]);return t.includes("typescript")&&r.add(".ts"),t.includes("less")&&r.add(".less"),t.includes("sass")&&(r.add(".sass"),r.add(".scss")),r}function isCodeFile(e){return/\.(json|wxml|wxss|js|wxs|ts|less|sass|scss)/.test(e)}function isMiniProgramCodeFile(e){return/\.(json|wxml|wxss|js|wxs)/.test(e)}function compareSemVer(e,t){if(!e&&!t)return 0;if(!e)return-1;if(!t)return 1;const r=/\d+/g,s=e.match(r),o=t.match(r);if(!s)return 1;if(!o)return-1;const n=s.map(e=>parseInt(e,10)),i=o.map(e=>parseInt(e,10)),a=s.length>o.length?o.length:s.length;for(let e=0;e<a;e++){if(n[e]<i[e])return-1;if(n[e]>i[e])return 1}return n.length===i.length?0:n.length<i.length?-1:1}exports.sourcePathToTargetPath=sourcePathToTargetPath,exports.getCompilerPlugins=getCompilerPlugins,exports.getSupportCodeFileExtSet=getSupportCodeFileExtSet,exports.isCodeFile=isCodeFile,exports.isMiniProgramCodeFile=isMiniProgramCodeFile,exports.compareSemVer=compareSemVer;