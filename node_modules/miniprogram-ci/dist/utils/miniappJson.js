"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.autoCompleteIOSPrivacyDesc=exports.isAndroidNeedClientJsExtInfo=exports.iosPrivacyDescObj=exports.getTargetMiniprogramArg=exports.getMiniprogramRoot=exports.getRawAppJSON=exports.iOSAppJsonIsUsingIPadResizable=exports.iOSMiniAppJsonIsUsingGDT=exports.iOSMiniAppJsonIsUsingTpush=exports.writeMiniAppJsonWithProjectPath=exports.isNewMiniAppProjectWithProjectPath=exports.isMiniAppProjectWithProjectPath=exports.tryGetPluginMiniappJson=exports.tryGetIOSMiniappJson=exports.tryGetAndroidMiniappJson=exports.tryGetOhosMiniappJson=exports.getMiniappJson=exports.getRawMiniappJson=exports.identityServiceConfigToMiniAppJSON=exports.PLATFORM=exports.miniAppPlatformMap=void 0;const tools_1=require("./tools"),officialDonutPlugin_1=require("./officialDonutPlugin"),tools_2=require("../utils/tools"),each=require("licia/each"),safeSet=require("licia/safeSet"),path=require("path"),fse=require("fs-extra"),_=require("lodash");var PLATFORM;function identityServiceConfigToMiniAppJSON(i,o={}){return o.identityServiceConfig=Object.assign(Object.assign({},o.identityServiceConfig),{authorizeMiniprogramType:1,miniprogramLoginPath:i}),o}function getRawMiniappJson(i){var o,t,e,n,s,p,r,a,c;i=(0,tools_1.unifyPath)(i);const g=path.posix.join(i,"project.miniapp.json");if(!fse.existsSync(g))return{};let h={};try{h=fse.readJsonSync(g)}catch(i){console.error(i)}return h.miniVersion&&"v1"!==h.miniVersion||((null===(o=h[PLATFORM.ANDROID])||void 0===o?void 0:o.projectPath)&&!path.isAbsolute(null===(t=h[PLATFORM.ANDROID])||void 0===t?void 0:t.projectPath)&&(h[PLATFORM.ANDROID].projectPath=path.posix.join(i,null===(e=h[PLATFORM.ANDROID])||void 0===e?void 0:e.projectPath)),(null===(n=h[PLATFORM.IOS])||void 0===n?void 0:n.projectPath)&&!path.isAbsolute(null===(s=h[PLATFORM.IOS])||void 0===s?void 0:s.projectPath)&&(h[PLATFORM.IOS].projectPath=path.posix.join(i,null===(p=h[PLATFORM.IOS])||void 0===p?void 0:p.projectPath))),(null===(r=h[PLATFORM.ANDROID])||void 0===r?void 0:r.projectPath)&&!path.isAbsolute(null===(a=h[PLATFORM.ANDROID])||void 0===a?void 0:a.projectPath)&&(h[PLATFORM.ANDROID].projectPath=path.posix.join(i,null===(c=h[PLATFORM.ANDROID])||void 0===c?void 0:c.projectPath)),h}function getMiniappJson(i,o="mini-weixin"){const t=Object.values(exports.miniAppPlatformMap),e=getRawMiniappJson(i),n=_.omit(e,t);return _.merge(n,e[o]||("mini-weixin"===o?e["mini-wechat"]:{}))}function tryGetOhosMiniappJson(i){let o;try{o=getMiniappJson(i,PLATFORM.OHOS);const t=tryGetPluginMiniappJson(i);o&&(o["mini-plugin"]=t)}catch(i){}return o||{}}function tryGetAndroidMiniappJson(i){let o;try{o=getMiniappJson(i,PLATFORM.ANDROID);const t=tryGetPluginMiniappJson(i);o&&(o["mini-plugin"]=t)}catch(i){}return o||{}}function tryGetIOSMiniappJson(i){let o;try{o=getMiniappJson(i,PLATFORM.IOS);const t=tryGetPluginMiniappJson(i);o&&(o["mini-plugin"]=t)}catch(i){}return o}function tryGetPluginMiniappJson(i){let o={};try{const t=getMiniappJson(i,PLATFORM.PLUGIN),e=getRawMiniappJson(i);o=(0,officialDonutPlugin_1.preprocessDonutPluginConfig)(t,e)}catch(i){}return o}function isMiniAppProjectWithProjectPath(i){const o=path.posix.join(i,"project.miniapp.json");return"multiPlatform"===fse.readJsonSync(o).projectArchitecture}function isNewMiniAppProjectWithProjectPath(i){const o=getRawMiniappJson(i);return isMiniAppProjectWithProjectPath(i)&&"v2"===o.miniVersion}function writeMiniAppJsonWithProjectPath(i,o){const t=path.posix.join(i,"project.miniapp.json");let e={};try{e=fse.readJsonSync(t)}catch(i){return}each(o,(i,o)=>{safeSet(e,o,i)}),fse.writeJSONSync(t,e,{spaces:2})}function iOSMiniAppJsonIsUsingTpush(i){const o=i.tpush&&!0===i.tpush.useExtendedLib_WeAppTPNS&&"number"==typeof i.tpush.accessID&&"string"==typeof i.tpush.accessKey&&"string"==typeof i.tpush.serviceBundleId;if(o&&(0,tools_1.compareVersion)(i.sdkVersion,"1.0.7")<=0)throw new Error(`can not use TPNS(消息推送) extendsdk in sdk version ${i.sdkVersion}, TPNS is supported in 1.0.8.`);return o}function iOSMiniAppJsonIsUsingGDT(i){const o=i.gdt&&!0===i.gdt.useExtendedLib_WeAppGDT&&"string"==typeof i.gdt.appid&&"string"==typeof i.gdt.splashAd_placementId;if(o&&(0,tools_1.compareVersion)(i.sdkVersion,"1.0.19")<=0)throw new Error(`can not use GDT(广告) extendsdk in sdk version ${i.sdkVersion}, GDT is supported in 1.0.20.`);return o}function iOSAppJsonIsUsingIPadResizable(i){return!0===getRawAppJSON(i).resizable}function getRawAppJSON(i){let o,t;const e=getMiniprogramRoot(i);o=e?path.posix.join(i,e,"app.json"):path.posix.join(i,"app.json");try{t=fse.readJsonSync(o)}catch(i){throw console.error(i),i}return t}function getMiniprogramRoot(i){const o=(0,tools_1.normalizePath)(path.posix.join(i,"project.config.json"));let t;try{t=fse.readJsonSync(o)}catch(i){throw console.error(i),i}return t.miniprogramRoot?t.miniprogramRoot:""}function getTargetMiniprogramArg(i,o){const t=(0,tools_1.normalizePath)(path.posix.join(i,"project.config.json"));let e;try{e=fse.readJsonSync(t)}catch(i){throw console.error(i),i}return e[o]||""}function isAndroidNeedClientJsExtInfo(i){const o=tryGetAndroidMiniappJson(i).sdkVersion;return(0,tools_2.compareSemVer)(o,"1.3.25")>0?1:0}exports.miniAppPlatformMap={"mini-android":"mini-android","mini-ios":"mini-ios","mini-weixin":"mini-weixin","mini-ohos":"mini-ohos"},function(i){i.ANDROID="mini-android",i.IOS="mini-ios",i.PLUGIN="mini-plugin",i.OHOS="mini-ohos"}(PLATFORM=exports.PLATFORM||(exports.PLATFORM={})),exports.identityServiceConfigToMiniAppJSON=identityServiceConfigToMiniAppJSON,exports.getRawMiniappJson=getRawMiniappJson,exports.getMiniappJson=getMiniappJson,exports.tryGetOhosMiniappJson=tryGetOhosMiniappJson,exports.tryGetAndroidMiniappJson=tryGetAndroidMiniappJson,exports.tryGetIOSMiniappJson=tryGetIOSMiniappJson,exports.tryGetPluginMiniappJson=tryGetPluginMiniappJson,exports.isMiniAppProjectWithProjectPath=isMiniAppProjectWithProjectPath,exports.isNewMiniAppProjectWithProjectPath=isNewMiniAppProjectWithProjectPath,exports.writeMiniAppJsonWithProjectPath=writeMiniAppJsonWithProjectPath,exports.iOSMiniAppJsonIsUsingTpush=iOSMiniAppJsonIsUsingTpush,exports.iOSMiniAppJsonIsUsingGDT=iOSMiniAppJsonIsUsingGDT,exports.iOSAppJsonIsUsingIPadResizable=iOSAppJsonIsUsingIPadResizable,exports.getRawAppJSON=getRawAppJSON,exports.getMiniprogramRoot=getMiniprogramRoot,exports.getTargetMiniprogramArg=getTargetMiniprogramArg,exports.iosPrivacyDescObj={NSPhotoLibraryUsageDescription:"当前应用程序需要访问用户的相册，如需修改描述请前往「project.miniapp.json - 隐私信息访问许可描述」修改，并且关闭「自动使用默认描述补全默认隐私信息访问许可」",NSCameraUsageDescription:"当前应用程序需要访问用户的相机，如需修改描述请前往「project.miniapp.json - 隐私信息访问许可描述」修改，并且关闭「自动使用默认描述补全默认隐私信息访问许可」",NSMicrophoneUsageDescription:"当前应用程序需要访问用户的麦克风，如需修改描述请前往「project.miniapp.json - 隐私信息访问许可描述」修改，并且关闭「自动使用默认描述补全默认隐私信息访问许可」",NSLocationWhenInUseUsageDescription:"当前应用程序需要在使用时访问用户的位置，如需修改描述请前往「project.miniapp.json - 隐私信息访问许可描述」修改，并且关闭「自动使用默认描述补全默认隐私信息访问许可」",NSLocationAlwaysUsageDescription:"当前应用程序需要始终访问用户的位置，如需修改描述请前往「project.miniapp.json - 隐私信息访问许可描述」修改，并且关闭「自动使用默认描述补全默认隐私信息访问许可」",NSLocationAlwaysAndWhenInUseUsageDescription:"当前应用程序需要始终和在使用时访问用户的位置，如需修改描述请前往「project.miniapp.json - 隐私信息访问许可描述」修改，并且关闭「自动使用默认描述补全默认隐私信息访问许可」",NSContactsUsageDescription:"当前应用程序需要访问用户的联系人，如需修改描述请前往「project.miniapp.json - 隐私信息访问许可描述」修改，并且关闭「自动使用默认描述补全默认隐私信息访问许可」",NSCalendarsUsageDescription:"当前应用程序需要访问用户的日历，如需修改描述请前往「project.miniapp.json - 隐私信息访问许可描述」修改，并且关闭「自动使用默认描述补全默认隐私信息访问许可」",NSRemindersUsageDescription:"当前应用程序需要访问用户的提醒事项，如需修改描述请前往「project.miniapp.json - 隐私信息访问许可描述」修改，并且关闭「自动使用默认描述补全默认隐私信息访问许可」",NSHealthShareUsageDescription:"",NSHealthUpdateUsageDescription:"",NSBluetoothPeripheralUsageDescription:"当前应用程序需要访问用户的蓝牙，如需修改描述请前往「project.miniapp.json - 隐私信息访问许可描述」修改，并且关闭「自动使用默认描述补全默认隐私信息访问许可」",NSBluetoothAlwaysUsageDescription:"当前应用程序需要始终访问用户的蓝牙，如需修改描述请前往「project.miniapp.json - 隐私信息访问许可描述」修改，并且关闭「自动使用默认描述补全默认隐私信息访问许可」",NSMotionUsageDescription:"",NSHomeKitUsageDescription:"",NSSiriUsageDescription:"",NSSpeechRecognitionUsageDescription:"当前应用程序需要使用语音识别，如需修改描述请前往「project.miniapp.json - 隐私信息访问许可描述」修改，并且关闭「自动使用默认描述补全默认隐私信息访问许可」",NSVideoSubscriberAccountUsageDescription:"",NSAppleMusicUsageDescription:"",NSFaceIDUsageDescription:"",NSNFCReaderUsageDescription:"",NSUserTrackingUsageDescription:"",NSLocalNetworkUsageDescription:"当前应用程序需要访问本地网络，如需修改描述请前往「project.miniapp.json - 隐私信息访问许可描述」修改，并且关闭「自动使用默认描述补全默认隐私信息访问许可」",NSSystemAdministrationUsageDescription:"当前应用程序需要进行系统管理操作，如需修改描述请前往「project.miniapp.json - 隐私信息访问许可描述」修改，并且关闭「自动使用默认描述补全默认隐私信息访问许可」",NFCReaderUsageDescription:"",NSHealthClinicalHealthRecordsShareUsageDescription:"",NSPhotoLibraryAddUsageDescription:"应用程序在请求访问照片库，如需修改描述请前往「project.miniapp.json - 隐私信息访问许可描述」修改，并且关闭「自动使用默认描述补全默认隐私信息访问许可"},exports.isAndroidNeedClientJsExtInfo=isAndroidNeedClientJsExtInfo;const autoCompleteIOSPrivacyDesc=i=>{const o=getRawMiniappJson(i);return!(!o["mini-ios"]||!o["mini-ios"].enableAutoCompletePrivacyDesc&&void 0!==o["mini-ios"].enableAutoCompletePrivacyDesc)&&(o["mini-ios"].privateDescriptions||(o["mini-ios"].privateDescriptions={}),Object.keys(exports.iosPrivacyDescObj).forEach(i=>{!o["mini-ios"].privateDescriptions[i]&&exports.iosPrivacyDescObj[i]&&(o["mini-ios"].privateDescriptions[i]=exports.iosPrivacyDescObj[i])}),writeMiniAppJsonWithProjectPath(i,o),!0)};exports.autoCompleteIOSPrivacyDesc=autoCompleteIOSPrivacyDesc;