"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.uploadGamePkgPlugByCos=exports.uploadGamePkg=void 0;const tslib_1=require("tslib"),url_config_1=require("../../config/url.config"),cosUpload_1=require("../../utils/cosUpload"),taskstatus_1=require("../../utils/taskstatus"),zlib_1=tslib_1.__importDefault(require("zlib")),querystring_1=tslib_1.__importDefault(require("querystring")),sign_1=require("../../utils/sign"),cos_upload_1=require("../cos-upload"),pack_1=require("../utils/pack"),fs_1=tslib_1.__importDefault(require("fs")),log=tslib_1.__importStar(require("../../utils/log")),config_1=require("../../config/config"),jsonParse_1=require("../../utils/jsonParse"),progressupdate_1=require("../utils/progressupdate"),locales_1=tslib_1.__importDefault(require("../../utils/locales/locales")),request_1=require("../../utils/request"),index_1=require("../../utils/asyncTask/index"),tools_1=require("../../utils/tools"),MIN_GAME_PKG_SIZE=5;async function uploadGamePkg(e){if(!fs_1.default.existsSync(e.pkgPath||"")||fs_1.default.statSync(e.pkgPath).isDirectory())throw new Error("[upload game pkg]failed! cant find file: "+e.pkgPath);const a=(0,progressupdate_1.transProgressUpdate)(e.onProgressUpdate||(e=>{if("object"==typeof e)try{const a=JSON.stringify(e);console.log(a)}catch(e){}console.log(""+e)})),t={appid:e.project.appid,version:e.version,desc:e.desc,robot:e.robot},o=`${url_config_1.GAME_PKG_UPLOAD_URL}?${querystring_1.default.stringify(t)}`,s=new taskstatus_1.TaskStatus(locales_1.default.config.UPLOAD.toString());a(s);const{fallback:r,uploadCOSCostTime:i}=await uploadGamePkgPlugByCos(e.pkgPath,o,e.project,e.robot,e.onProgressUpdate);return null!=i||log.log("[upload game pkg] total cost time : "+i),r&&log.error("[upload game pkg] failed!"),s.done(),a(s),{success:!r}}async function uploadGamePkgPlugByCos(e,a,t,o,s){let r;const i=await(0,tools_1.generateFileMD5)(e),l=fs_1.default.statSync(e).size;if(log.info("[upload game pkg] rawSize: "+l),Math.ceil(l/1024/1024)<5)return log.error("[upload game pkg] file size must larger than 5M"),{fallback:!0};try{const e=await(0,sign_1.getSignature)(t.privateKey,t.appid),a=await(0,cos_upload_1.innerRequest)(url_config_1.GET_GAME_PKG_UPLOAD_INFO,JSON.stringify({appid:t.appid,signature:e,robot:o,rawSize:""+l,md5:i}));r=Object.assign(Object.assign({},a),a.upload_info)}catch(e){return log.error("[upload game pkg] getUploadInfo failed",e),{fallback:!0}}log.info("[upload game pkg] get upload info succcessfuly");const u=await(0,index_1.encryptLocalFile)(e,r),n=Date.now();try{await(0,cosUpload_1.uploadToCosCore)({uploadBuf:u,region:"ap-shanghai",onProgress:e=>{null==s||s(e);try{log.log(`[upload game pkg] percent: ${Math.floor(100*e.percent)}% loaded: ${e.loaded}bytes total: ${e.total}bytes`)}catch(e){}},getUploadInfoFunc:async()=>r,getAuthFunc:async e=>{let a,s={},i={};switch(e.action){case"name/cos:InitiateMultipartUpload":s={uploads:""};break;case"name/cos:ListMultipartUploads":s={uploads:"",prefix:r.object},i={};break;case"name/cos:UploadPart":case"name/cos:ListParts":case"name/cos:CompleteMultipartUpload":s={uploadId:e.uploadId},i={};break;default:throw log.error("[upload game pkg] cos upload no action"),new Error("[upload game pkg] cos upload no action")}try{const l=await(0,sign_1.getSignature)(t.privateKey,t.appid),u=await(0,cos_upload_1.innerRequest)(url_config_1.GET_GAME_PKG_UPLOAD_SIGN,JSON.stringify({appid:t.appid,signature:l,robot:o,signOpts:JSON.stringify({checksum:r.checksum,action:e.action,upload_id:e.uploadId,task_id:r.task_id,headers:i,params:s})}));a={Authorization:u.sign,SecurityToken:u.token,AuthExpireTime:u.expired_time}}catch(e){throw log.info("game pkg uploadToCos safely failed"),log.log(e),new Error("game pkg uploadToCos safely failed")}return a}})}catch(e){return log.error("[upload game pkg] getUploadInfo failed",e.message),{fallback:!0}}const p=Date.now()-n,g=await(0,tools_1.generateFileMD5)(u),d=""+fs_1.default.statSync(u).size,c=await(0,sign_1.getSignature)(t.privateKey,t.appid),_=`${a}&task_id=${r.task_id}&new_hash=${g}&upload_cos_cost_time=${p}&str_stored_size=${d}`;log.info("request url:",_);const f=await(0,request_1.request)({url:_,method:"post",body:zlib_1.default.gzipSync((0,pack_1.pack)({[index_1.SIGNATURE_FILE_NAME]:JSON.stringify({signature:c,version:config_1.CI_VERSION})}).buffer)});if(0!==(0,jsonParse_1.jsonRespParse)(f.body.toString(),a).errCode)throw new Error(f.body.toString());for(;;){const e=await(0,sign_1.getSignature)(t.privateKey,t.appid),a=await(0,cos_upload_1.innerRequest)(`${url_config_1.GET_GAME_PKG_ASYNC_RESULT}?task_id=${r.task_id}`,JSON.stringify({appid:t.appid,signature:e,robot:o}));if(2!==a.status){if(3===a.status){return{fallback:!1,body:a,uploadCOSCostTime:Date.now()-n}}if(0===a.status)throw new Error(`upload failed with status ${a.status}, task not found`);throw new Error("upload failed with status "+a.status)}await new Promise(e=>{setTimeout(e,1e3)})}}exports.uploadGamePkg=uploadGamePkg,exports.uploadGamePkgPlugByCos=uploadGamePkgPlugByCos;