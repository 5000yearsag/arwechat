# 微信小程序CI自动上传配置

## 1. 环境准备

### 1.1 安装依赖
```bash
npm install miniprogram-ci --save
```

### 1.2 获取代码上传密钥
1. 登录 [微信公众平台](https://mp.weixin.qq.com/)
2. 进入开发管理 -> 开发设置
3. 点击"生成代码上传密钥"
4. 下载密钥文件，重命名为 `private.key`
5. 将 `private.key` 放在项目根目录

### 1.3 配置IP白名单
在微信公众平台的开发设置中，添加你的服务器IP到"代码上传密钥"的IP白名单中。

## 2. 使用方法

### 2.1 上传小程序
```bash
# 使用默认版本号和描述上传
npm run upload

# 指定版本号和描述上传
node upload.js 1.0.1 "修复bug" development

# 参数说明:
# 参数1: 版本号 (默认: 1.0.0)
# 参数2: 版本描述 (默认: "版本${version}自动上传")
# 参数3: 环境 (默认: development, 可选: development|trial|release)
```

### 2.2 生成预览二维码
```bash
# 生成预览二维码
npm run preview

# 二维码将保存为 preview.jpg
```

## 3. 配置文件说明

### 3.1 upload.js
主要的CI上传脚本，包含以下功能：
- 自动读取项目配置
- 支持版本号和描述自定义
- 包含进度回调
- 错误处理
- 预览二维码生成

### 3.2 忽略文件列表
默认忽略以下文件/目录：
- `node_modules/**/*`
- `.git/**/*`
- `upload.js`
- `private.key`

## 4. 项目信息
- AppID: wx360d6d845e60562e
- 项目类型: miniProgram
- 项目路径: 当前目录

## 5. 编译设置
- ES6转ES5: 启用
- ES7转ES5: 启用
- 代码压缩: 启用
- 代码保护: 关闭
- JS压缩: 启用
- WXML压缩: 启用
- WXSS压缩: 启用
- WXSS自动补全: 启用

## 6. 注意事项
1. 确保 `private.key` 文件存在且有效
2. 确保IP地址在白名单中
3. 上传前确保代码已经测试通过
4. 版本号应该按照语义化版本规范递增
5. 不要将 `private.key` 文件提交到版本控制系统

## 7. 错误排查
- 如果提示"私钥无效"，检查private.key文件是否正确
- 如果提示"IP不在白名单"，检查微信公众平台的IP白名单设置
- 如果上传失败，检查网络连接和项目代码完整性