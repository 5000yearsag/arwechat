<xr-scene ar-system="modes:Marker" bind:ready="handleReady">
  <!-- 给场景添加灯光，给加载的模型提供光照 -->
  <xr-light type="ambient" color="1 1 1" intensity="1" />
  <xr-light type="directional" rotation="40 70 0" color="1 1 1" intensity="3" cast-shadow />

  <!-- 资源加载 -->
  <xr-assets bind:loaded="handleAssetsLoaded" bind:progress="handleAssetsProgress">
    <xr-asset-load type="texture" asset-id="bg" src="https://holodata.s3.cn-northwest-1.amazonaws.com.cn/nameCardData/mingpiantu.png" />
    <xr-asset-material asset-id="simple-mat" effect="simple" />
    <xr-asset-material asset-id="text-mat" effect="simple" />
    <block wx:for="{{sceneList}}" wx:key="sceneUuid">
      <block wx:if="{{item.type === 'video'}}">
        <xr-asset-load
          type="video-texture"
          asset-id="video_{{item.sceneUuid}}"
          options="loop:true"
          src="{{item.arResourceUrl}}"
        />
        <xr-asset-material
          wx:if="{{item.videoEffect === 'tsbs'}}"
          asset-id="mat_{{item.sceneUuid}}"
          effect="video-tsbs"
          uniforms="u_baseColorMap:video-video_{{item.sceneUuid}}"
        />
        <xr-asset-material
          asset-id="mat_{{item.sceneUuid}}"
          effect="simple"
          uniforms="u_baseColorMap: video-video_{{item.sceneUuid}}"
        />
      </block>
      <block wx:elif="{{item.type === 'model'}}">
        <xr-asset-load
          type="gltf"
          asset-id="model_{{item.sceneUuid}}"
          src="{{item.arResourceUrl}}"
          options="ignoreError: 10602"
        />
      </block>
    </block>
  </xr-assets>

  <!-- 根据场景列表添加tracker, 视频资源加载后 -->
  <block
    wx:if="{{assetsLoaded}}"
    wx:for="{{sceneList}}"
    wx:key="sceneUuid"
  >
    <xr-node wx:if="{{item.type === 'video'}}">
      <xr-ar-tracker
        data-asset-id="{{item.type}}_{{item.sceneUuid}}"
        data-asset-type="{{item.type}}"
        mode="Marker"
        src="{{item.sceneImgUrl}}"
        bind:ar-tracker-switch="handleTrackerSwitch"
      >
        <xr-mesh
          wx:if="{{item.videoEffect === 'tsbs'}}"
          node-id="video-cube-{{item.sceneUuid}}"
          geometry="cube"
          material="mat_{{item.sceneUuid}}"
          scale="{{item.xScale}} 0 {{item.yScale}}"
        />
        <xr-mesh
          wx:else
          node-id="video-plane-{{item.sceneUuid}}"
          geometry="plane"
          material="mat_{{item.sceneUuid}}"
          scale="{{item.xScale}} 1 {{item.yScale}}"
        />
      </xr-ar-tracker>
    </xr-node>
    <xr-node wx:elif="{{item.type === 'model'}}">
      <xr-ar-tracker
        data-asset-id="{{item.type}}_{{item.sceneUuid}}"
        data-asset-type="{{item.type}}"
        mode="Marker"
        src="{{item.sceneImgUrl}}"
        bind:ar-tracker-switch="handleTrackerSwitch"
      >
        <xr-gltf
          model="model_{{item.sceneUuid}}"
          anim-autoplay
          cube-shape="autoFit:true"
          position="{{item.position.x || 0}} {{item.position.y || 0}} {{item.position.z || 0}}"
          scale="{{item.scale.x || 1}} {{item.scale.y || 1}} {{item.scale.z || 1}}"
          rotation="{{item.rotation.x || 0}} {{item.rotation.y || 0}} {{item.rotation.z || 0}}"
        />
        <xr-node rotation="-90 0 0" position="0 0 0.8">
          <xr-node node-id="ui_block_{{item.sceneUuid}}" scale="0.1 0.1 0.1">
            <xr-mesh
              position="0 0 -0.01" scale="10 1 5" rotation="90 0 0" geometry="plane" material="simple-mat"
              uniforms="u_baseColorMap: bg" states="cullOn: false, alphaMode: BLEND,renderQueue: 2500"
            ></xr-mesh>
            <xr-node node-id="text_wrap_{{item.sceneUuid}}" position="-4 1.4 0">
              <xr-text
                material="text-mat" value="{{congratulation}}"
                position="0 0 0" never-cull
                width="8"
                size="0.6" anchor="0 1" uniforms="u_baseColorFactor:1.0 1.0 1.0 1"
              ></xr-text>
            </xr-node>
          </xr-node>
        </xr-node>
      </xr-ar-tracker>
    </xr-node>
  </block>

  <xr-camera clear-color="0.4 0.8 0.6 1" background="ar" is-ar-camera>
  </xr-camera>
</xr-scene>
